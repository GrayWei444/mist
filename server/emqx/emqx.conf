# SafeTalk EMQX Configuration

# 節點名稱
node {
    name = "safetalk@127.0.0.1"
    cookie = "safetalk_secret_cookie_change_me"
}

# 監聽器
listeners.tcp.default {
    bind = "0.0.0.0:1883"
    max_connections = 10000
}

listeners.ws.default {
    bind = "0.0.0.0:8083"
    max_connections = 10000
    websocket.mqtt_path = "/mqtt"
}

listeners.wss.default {
    bind = "0.0.0.0:8084"
    max_connections = 10000
    websocket.mqtt_path = "/mqtt"
    ssl_options {
        # 由 Caddy 處理 TLS，這裡可以使用自簽憑證
        certfile = "/opt/emqx/etc/certs/cert.pem"
        keyfile = "/opt/emqx/etc/certs/key.pem"
    }
}

# 認證 - 使用公鑰作為 username
authentication = [
    {
        mechanism = "password_based"
        backend = "built_in_database"
        enable = true
    }
]

# 授權規則
authorization {
    no_match = deny
    deny_action = disconnect
    cache {
        enable = true
        max_size = 1000
        ttl = "1m"
    }
    sources = [
        {
            type = "built_in_database"
            enable = true
        }
    ]
}

# 訊息保留 (離線訊息暫存)
# 注意：SafeTalk 設計為盡量不在伺服器儲存訊息
# 此設定僅用於信令暫存
session_persistence {
    enable = true
    storage {
        type = "disc"
    }
    max_retain_undelivered = 100
    message_gc_interval = "1h"
    session_message_gc_interval = "1m"
}

# Dashboard
dashboard {
    listeners.http {
        bind = "0.0.0.0:18083"
    }
    default_username = "admin"
    default_password = "safetalk_admin_change_me"
}

# 日誌
log.console_handler {
    level = warning
    enable = true
}
