version: '3.8'

services:
  # Caddy - Web Server & Reverse Proxy
  caddy:
    image: caddy:2-alpine
    container_name: safetalk-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - ../dist:/srv/app:ro
    networks:
      - safetalk

  # EMQX - MQTT Broker
  emqx:
    image: emqx/emqx:5.3
    container_name: safetalk-emqx
    restart: unless-stopped
    ports:
      - "1883:1883"     # MQTT
      - "8083:8083"     # WebSocket
      - "8084:8084"     # WSS
      - "18083:18083"   # Dashboard
    volumes:
      - ./emqx/emqx.conf:/opt/emqx/etc/emqx.conf:ro
      - emqx_data:/opt/emqx/data
    environment:
      - EMQX_NAME=safetalk
      - EMQX_HOST=127.0.0.1
    networks:
      - safetalk

  # Coturn - STUN/TURN Server
  coturn:
    image: coturn/coturn:4.6
    container_name: safetalk-coturn
    restart: unless-stopped
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "5349:5349/tcp"   # TLS
      - "49152-49200:49152-49200/udp"  # 中繼端口範圍
    volumes:
      - ./coturn/turnserver.conf:/etc/turnserver.conf:ro
    command: ["-c", "/etc/turnserver.conf"]
    networks:
      - safetalk

volumes:
  caddy_data:
  caddy_config:
  emqx_data:

networks:
  safetalk:
    driver: bridge
